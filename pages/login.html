
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
    }

    .login-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      width: 340px;
      padding: 40px 30px;
      text-align: center;
      position: relative;
      min-height: 520px; /* altura fixa para não "pular" */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }

    .login-container img.logo {
      width: 140px;
      margin-bottom: 20px;
    }

    .login-container h2 {
      margin-bottom: 16px;
      font-size: 1.6rem;
      color: #333;
    }

    .login-container .error-msg {
      color: #e63946;
      font-size: 0.9rem;
      min-height: 1.2em;
      margin-bottom: 8px;
    }

    /* Espaço fixo para o ícone */
    .icon-alerta-svg {
      margin: 10px auto 20px auto;
      width: 64px;
      height: 64px;
      animation: blink 2s infinite;
      visibility: hidden; /* já existe no layout, mas invisível */
    }

    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }

    .login-container input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }

    .login-container button {
      width: 100%;
      padding: 12px 14px;
      background: #0077cc;
      color: #fff;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-container button:hover {
      background: #005fa3;
    }

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  min-width: 260px;
  padding: 12px 16px;
  border-radius: 8px;
  background: #e63946;
  color: #fff;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 6px;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
}

.toast-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.toast-counter {
  font-weight: bold;
}

.toast-icon {
  display: inline-block;
  animation: spin 1s linear infinite;
}

.toast-bar {
  height: 4px;
  background: rgba(255,255,255,0.8);
  width: 100%;
  border-radius: 2px;
  margin-top: 6px;
}

@keyframes fadeIn {
  to { opacity: 1; }
}

@keyframes toastProgress {
  from { width: 100%; }
  to { width: 0%; }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.error-msg {
  color: #e63946;
  font-size: 0.9rem;
  min-height: 1.2em;
  margin-bottom: 8px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.error-msg.active {
  opacity: 1;
}
/* Popup principal */
#popupVoucher {
  display: none;
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

/* Caixa branca */
#popupVoucher .popupContent {
  background: #fff;
  width: 420px;
  max-width: 90%;
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 20px;
}

/* Ícones no topo */
#popupVoucher .iconsTop {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
}

#popupVoucher .ticketIcon,
#popupVoucher .planetIcon {
  width: 36px;
  height: 36px;
  object-fit: contain;
}

/* SVG de progresso */
#popupVoucher .progressCircle {
  width: 100px; /* tamanho do círculo */
  height: 100px;
  margin: 0 auto;
  position: relative;
}

#popupVoucher .progressCircle circle {
  transition: stroke-dashoffset 0.3s linear;
}

/* Texto centralizado no círculo */
#popupVoucher .progressText {
  font-family: Arial, sans-serif;
  font-size: 18px;
  dominant-baseline: middle;
  text-anchor: middle;
  transform: rotate(90deg) translate(0px, -50px); /* ajustado para círculo menor */
}

/* Títulos e textos */
#popupVoucher h2 {
  font-size: 20px;
  font-weight: bold;
  margin: 0;
}

#popupVoucher p {
  font-size: 14px;
  margin: 0;
  color: #333;
}

/* Entrada suave do popup */
#popupVoucher.show {
  animation: popupFadeIn 0.4s ease forwards;
}

@keyframes popupFadeIn {
  0% { opacity: 0; transform: translateY(-20px); }
  100% { opacity: 1; transform: translateY(0); }
}
/* Overlay geral */
#overlaylogin {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4); /* escurece o fundo */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-family: 'Arial', sans-serif;
  opacity: 1;
  transition: opacity 0.4s ease;
}

/* Popup centralizado */
#overlaylogin .popup {
  background: #ffffff; /* branco */
  padding: 40px 30px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  max-width: 360px;
  width: 90%;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  text-align: center;
  color: #222; /* texto escuro */
  animation: popupIn 0.4s ease;
}

/* Títulos */
#overlaylogin h2 {
  margin: 0;
  font-size: 1.6rem;
  color: #222;
}
#overlaylogin h5 {
  margin: 0;
  font-size: 1rem;
  font-weight: normal;
  color: #555;
}

/* Loader */
.loader {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  position: relative;
  animation: rotate 0.7s linear infinite;
}
.loader::before,
.loader::after {
  content: "";
  box-sizing: border-box;
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 5px solid #ccc; /* tom branco mais escuro */
  animation: prixClipFix 1.4s linear infinite;
}
.loader::after {
  transform: rotate3d(90, 90, 0, 180deg);
  border-color: #007bff; /* azul */
}

/* Animações */
@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes prixClipFix {
  0% { clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0); }
  50% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0, 100% 0); }
  75%, 100% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%); }
}

/* Entrada do popup */
@keyframes popupIn {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

#popupCEP {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10001;
  font-family: Arial, sans-serif;
}

#popupCEP .cepContent {
  background: #fff;
  padding: 25px 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  width: 320px;
  animation: fadeInScale 0.3s ease;
}

#popupCEP h3 {
  margin-bottom: 15px;
  color: #333;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.cepIcon {
  width: 24px;
  height: 24px;
}

#popupCEP input {
  width: 100%;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 15px;
  text-align: center;
  transition: border-color 0.2s;
}
#popupCEP input:focus {
  border-color: #478ad1;
  outline: none;
}

#popupCEP button {
  padding: 10px 15px;
  background: #478ad1;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}
#popupCEP button:hover {
  background: #3b75b8;
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}


  </style>
</head>
<body>

  <div class="login-container">
    <!-- Logo -->
    <img src="Imagens/bigbanner.png" alt="Logo" class="logo">

    <h2>Login</h2>

    <!-- Mensagem de erro -->
    <div id="loginError" class="error-msg"></div>

    <!-- Ícone de alerta piscando -->
    <div id="icon-alerta-svg" class="icon-alerta-svg" role="img" aria-label="Alerta">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="32" cy="32" r="30" fill="#fff" stroke="#e63946" stroke-width="4"></circle>
        <rect x="30" y="18" width="4" height="22" fill="#e63946"></rect>
        <circle cx="32" cy="46" r="3" fill="#e63946"></circle>
      </svg>
    </div>

    <!-- Formulário de login -->
    <input id="loginUser" type="text" placeholder="Usuário" autocomplete="username" />
    <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
    <button id="loginBtn">Entrar</button>
  </div>

<div id="popupVoucher" style="display: none;">
  <div class="popupContent">
    <div class="iconsTop">
      <img class="ticketIcon" src="https://cdn-icons-png.flaticon.com/128/3702/3702886.png" alt="Ticket">
      <img class="planetIcon" src="https://cdn-icons-png.flaticon.com/128/3385/3385744.png" alt="Internet">
    </div>

    <!-- Círculo de progresso SVG -->
    <svg class="progressCircle" width="200" height="200" viewBox="-25 -25 250 250" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg);">
      <!-- fundo do círculo -->
      <circle r="90" cx="100" cy="100" fill="transparent" stroke="#e0e0e0" stroke-width="16px"></circle>
      <!-- círculo do progresso -->
      <circle class="progressFill" r="90" cx="100" cy="100" fill="transparent" stroke="#478ad1" stroke-width="16px" stroke-linecap="round"
              stroke-dasharray="565.48" stroke-dashoffset="565.48"></circle>
      <!-- texto central -->
      <text class="progressText" x="100" y="117" fill="#478ad1" font-size="52px" font-weight="bold" text-anchor="middle">0%</text>
    </svg>

    <h2>Acesso de visitante</h2>
    <p>Validando seu voucher, aguarde...</p>
    <p>Após a liberação, você poderá criar cartazes e imprimir declarações temporariamente.</p>
  </div>
</div>


<div id="overlaylogin" style="display: none;">
  <div class="popup">
    <h2>Autenticando...</h2>
    <h5>Por favor, aguarde enquanto liberamos sua sessão</h5>
    <span class="loader"></span>
  </div>
</div>

<div id="popupCEP" style="display:none;">
  <div class="cepContent">
    <h3>
      <img class="cepIcon" src="https://cdn-icons-png.flaticon.com/128/1865/1865153.png" alt="Mapa" />
      Insira seu CEP
    </h3>
    <input type="text" id="cepInput" placeholder="Ex: 60140-110" />
    <button id="cepConfirm">Confirmar</button>
  </div>
</div>

<script>


  document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('loginBtn');
  const inputUser = document.getElementById('loginUser');
  const inputPass = document.getElementById('loginPass');
  const overlayLogin = document.getElementById('overlaylogin');
  const popupVoucher = document.getElementById('popupVoucher');
  const progressCircle = popupVoucher.querySelector('.progressCircle');
  const progressText = popupVoucher.querySelector('.progressText');
  const popupCEP = document.getElementById("popupCEP");
  const cepInput = document.getElementById("cepInput");
  const cepConfirm = document.getElementById("cepConfirm");

  let userPerm = null;
  let isVisitante = false;
  let localTentativa = null;
  let currentUser = "";
  let currentPass = "";

  function mostrarErroLogin(msg, duracao = 2500) {
    const errorBox = document.getElementById('loginError');
    errorBox.textContent = msg;
    errorBox.classList.add('active');
    setTimeout(() => {
      errorBox.classList.remove('active');
      errorBox.textContent = "";
    }, duracao);
  }

  function mostrarAvisoToast(msg, duracao = 2500, sucesso = false) {
    const oldToast = document.querySelector(".toast");
    if (oldToast) oldToast.remove();

    const toast = document.createElement("div");
    toast.className = "toast";
    toast.style.background = sucesso ? "#2a9d8f" : "#e63946";
    toast.innerHTML = `<div class="toast-content"><span class="toast-msg">${msg}</span></div><div class="toast-bar"></div>`;
    document.body.appendChild(toast);

    const bar = toast.querySelector(".toast-bar");
    bar.style.animation = `toastProgress ${duracao}ms linear forwards`;

    setTimeout(() => toast.remove(), duracao);
  }

  async function pegarCidade(lat, lng) {
    try {
      const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      const data = await resp.json();
      return (data.address.city || data.address.town || data.address.village || "").toLowerCase();
    } catch {
      return null;
    }
  }

  // Função para processar login (chamada pelo botão ou pelo CEP)
  async function processarLogin() {
    if (!currentUser || !currentPass) {
      mostrarErroLogin("Usuário ou senha não preenchidos");
      mostrarAvisoToast("Preencha usuário e senha");
      return;
    }

    let attemptsData = JSON.parse(localStorage.getItem(`loginAttempts_${currentUser}`) || '{"count":0,"timeout":0}');
    const now = Date.now();
    if (attemptsData.timeout && now < attemptsData.timeout) {
      const remaining = Math.ceil((attemptsData.timeout - now) / 1000);
      mostrarAvisoToast(`Login bloqueado. Aguarde ${remaining}s.`);
      return;
    }

    const actionType = isVisitante ? "voucher" : "login";

    try {
      if (!isVisitante) overlayLogin.style.display = 'flex';
      const response = await fetch("https://proxy-apps-script.gab-oliveirab27.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: actionType, user: currentUser, pass: currentPass, local: localTentativa })
      });
      const result = await response.json();

      if ((result.status === "autorizado") || (result.ok && isVisitante)) {
        localStorage.removeItem(`loginAttempts_${currentUser}`);
        const authSession = { user: currentUser, start: Date.now(), duration: 2*60*60*1000 };
        localStorage.setItem("authSession", JSON.stringify(authSession));

        if (isVisitante) {
          overlayLogin.style.display = 'none';
          popupVoucher.style.display = 'flex';

          // Inicia progress do SVG
          let progress = 20;
          const circle = progressCircle.querySelector('circle:nth-child(2)');
          const radius = circle.r.baseVal.value;
          const circ = 2 * Math.PI * radius;
          circle.style.strokeDasharray = circ;
          circle.style.strokeDashoffset = circ * (1 - progress/100);
          progressText.textContent = `${Math.floor(progress)}%`;

          const interval = setInterval(() => {
            progress += Math.random() * 5;
            if (progress > 100) progress = 100;
            circle.style.strokeDashoffset = circ * (1 - progress/100);
            progressText.textContent = `${Math.floor(progress)}%`;
            if (progress >= 100) {
              clearInterval(interval);
              setTimeout(() => {
                popupVoucher.style.display = 'none';
                window.location.href = "../index.html";
              }, 500);
            }
          }, 200);

        } else {
          setTimeout(() => {
            overlayLogin.style.display = 'none';
            mostrarAvisoToast("Login autorizado. Entrando...", 1500, true);
            setTimeout(() => window.location.href = "../index.html", 500);
          }, 500);
        }

      } else {
        overlayLogin.style.display = 'none';
        attemptsData.count = (attemptsData.count || 0) + 1;
        if (attemptsData.count >= 5) attemptsData.timeout = now + 30000;
        localStorage.setItem(`loginAttempts_${currentUser}`, JSON.stringify(attemptsData));

        if (result.motivo === "localincorreto" || result.motivo === "local-nao-permitido") {
          window.location.href = "bloqueado.html?reason=local-nao-permitido";
          return;
        }

        const motivoMsg = result.motivo === "senhaincorreta"
          ? "Senha incorreta"
          : result.ok === false && result.error
            ? result.error
            : "Não autorizado";

        mostrarErroLogin(motivoMsg);
        mostrarAvisoToast(motivoMsg);
      }

    } catch (err) {
      overlayLogin.style.display = 'none';
      console.error("Erro na requisição:", err);
      mostrarErroLogin("Falha de conexão com servidor");
      mostrarAvisoToast("Erro de rede. Tente novamente.");
    }
  }

  // Função principal do login
  async function login() {
    currentUser = inputUser.value.trim().toLowerCase();
    currentPass = inputPass.value.trim();

    if (!currentUser || !currentPass) {
      mostrarErroLogin("Preencha usuário e senha");
      mostrarAvisoToast("Preencha usuário e senha.");
      return;
    }

    let attemptsData = JSON.parse(localStorage.getItem(`loginAttempts_${currentUser}`) || '{"count":0,"timeout":0}');
    const now = Date.now();
    if (attemptsData.timeout && now < attemptsData.timeout) {
      const remaining = Math.ceil((attemptsData.timeout - now) / 1000);
      mostrarAvisoToast(`Login bloqueado. Aguarde ${remaining}s.`);
      return;
    }

    isVisitante = currentUser === "visitante";

    try {
      if (!isVisitante && !["admin","suporte"].includes(userPerm)) {
        if (!navigator.geolocation) throw { code: 4, message: "Navegador não suporta geolocalização" };
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000 });
        });
        localTentativa = await pegarCidade(pos.coords.latitude, pos.coords.longitude);
        if (!localTentativa) throw { code: 3, message: "Não capturou cidade" };
      } else if (isVisitante) {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000 });
          });
          localTentativa = await pegarCidade(pos.coords.latitude, pos.coords.longitude);
        } catch { /* não bloqueia, vai para CEP */ }
      }
    } catch (err) {
      let msg = "Não foi possível validar sua localização.";
      if (err.code === 1) msg = "Permissão de localização negada.";
      else if (err.code === 2) msg = "Localização indisponível.";
      else if (err.code === 3) msg = "Tempo esgotado ao obter localização.";
      else if (err.code === 4) msg = err.message;

      mostrarErroLogin(msg);
      popupCEP.style.display = "flex"; // abre popup direto
      return;
    }

    if (!localTentativa) {
      popupCEP.style.display = "flex"; // abre popup direto
      return;
    }

    processarLogin();
  }

  btn.addEventListener('click', login);
  [inputUser, inputPass].forEach(input => {
    input.addEventListener('keydown', e => {
      if (e.key === "Enter") {
        e.preventDefault();
        login();
      }
    });
  });

  // Função de CEP
  async function confirmarCEP() {
    let cep = cepInput.value.replace(/\D/g,"");
    if (cep.length !== 8) {
      mostrarErroLogin("CEP inválido, digite 8 números.");
      mostrarAvisoToast("CEP inválido, digite novamente.");
      return;
    }

    try {
      const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const data = await resp.json();
      if (data.erro) throw new Error("CEP não encontrado");

      localTentativa = data.localidade.toLowerCase();
      popupCEP.style.display = "none";
      mostrarAvisoToast(`Cidade detectada: ${data.localidade}`);
      processarLogin();
    } catch(err) {
      mostrarErroLogin(err.message);
      mostrarAvisoToast(err.message);
    }
  }

  cepConfirm.addEventListener('click', confirmarCEP);
  cepInput.addEventListener('keydown', e => {
    if (e.key === "Enter") {
      e.preventDefault();
      confirmarCEP();
    }
  });

});


</script>


</body>
</html>

